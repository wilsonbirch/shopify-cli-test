{"version":3,"file":"server.js","sourceRoot":"","sources":["../../../../../src/cli/services/dev/graphiql/server.ts"],"names":[],"mappings":"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","sourcesContent":["import {defaultQuery, template} from './template.js'\nimport {urlNamespaces} from '../../../constants.js'\nimport express from 'express'\nimport bodyParser from 'body-parser'\nimport '@shopify/shopify-api/adapters/node'\nimport {shopifyApi, LogSeverity, Session, LATEST_API_VERSION, ApiVersion, HttpResponseError} from '@shopify/shopify-api'\nimport {renderLiquidTemplate} from '@shopify/cli-kit/node/liquid'\nimport {outputDebug, outputInfo, outputWarn} from '@shopify/cli-kit/node/output'\nimport {Server} from 'http'\nimport {Writable} from 'stream'\n\nfunction createShopify({\n  stdout,\n  apiKey,\n  apiSecret,\n  scopes,\n  url,\n  shopCustomDomain,\n}: {\n  stdout: Writable\n  apiKey: string\n  apiSecret: string\n  scopes: string[]\n  url: string\n  shopCustomDomain?: string\n}) {\n  return shopifyApi({\n    apiKey,\n    apiSecretKey: apiSecret,\n    scopes,\n    hostName: url,\n    apiVersion: LATEST_API_VERSION,\n    isEmbeddedApp: false,\n    customShopDomains: shopCustomDomain ? [shopCustomDomain] : [],\n    logger: {\n      level: LogSeverity.Debug,\n      timestamps: false,\n      httpRequests: true,\n      // eslint-disable-next-line @typescript-eslint/no-misused-promises\n      log: async (severity, message) => {\n        if (severity === LogSeverity.Debug) {\n          outputDebug(message, stdout)\n        } else if (severity === LogSeverity.Error || severity === LogSeverity.Warning) {\n          outputWarn(message, stdout)\n        } else {\n          outputInfo(message, stdout)\n        }\n      },\n    },\n  })\n}\n\ninterface SetupGraphiQLServerOptions {\n  stdout: Writable\n  port: number\n  appName: string\n  appUrl: string\n  apiKey: string\n  apiSecret: string\n  url: string\n  storeFqdn: string\n  scopes: string[]\n  shopCustomDomain?: string\n}\n\nexport function setupGraphiQLServer({\n  stdout,\n  port,\n  appName,\n  appUrl,\n  apiKey,\n  apiSecret,\n  url,\n  storeFqdn,\n  scopes,\n  shopCustomDomain,\n}: SetupGraphiQLServerOptions): Server {\n  outputDebug(`Setting up GraphiQL HTTP server...`, stdout)\n\n  const shopify = createShopify({stdout, apiKey, apiSecret, url, scopes, shopCustomDomain})\n  const app = express()\n    // Make the app accept all routes starting with /.shopify/xxx as /xxx\n    .use((req, _res, next) => {\n      if (req.path.startsWith(`/${urlNamespaces.devTools}`)) {\n        req.url = req.url.replace(`/${urlNamespaces.devTools}`, '')\n      }\n      next()\n    })\n\n  let session: Session | undefined\n\n  async function beginAuth(req: express.Request, res: express.Response) {\n    stdout.write('Initiating OAuth flow...')\n    await shopify.auth.begin({\n      shop: shopify.utils.sanitizeShop(storeFqdn, true)!,\n      callbackPath: `/${urlNamespaces.devTools}/graphiql/auth/callback`,\n      isOnline: false,\n      rawRequest: req,\n      rawResponse: res,\n    })\n  }\n\n  async function isAuthorized(): Promise<boolean> {\n    if (!session) return false\n    const client = new shopify.clients.Graphql({session, apiVersion: LATEST_API_VERSION})\n    try {\n      await client.query({data: '{ shop { id } }'})\n      return true\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      return (error as HttpResponseError)?.response?.code !== 401\n    }\n  }\n\n  app.get('/graphiql/ping', (_req, res) => {\n    res.send('pong')\n  })\n\n  // eslint-disable-next-line @typescript-eslint/no-misused-promises\n  app.get('/graphiql/auth/callback', async (req, res) => {\n    outputDebug('Handling /graphiql/auth/callback request', stdout)\n    // The library will automatically set the appropriate HTTP headers\n    const callback = await shopify.auth.callback({\n      rawRequest: req,\n      rawResponse: res,\n    })\n    session = callback.session\n    // You can now use callback.session to make API requests\n    res.redirect(`/${urlNamespaces.devTools}/graphiql`)\n  })\n\n  // eslint-disable-next-line @typescript-eslint/no-misused-promises\n  app.get('/graphiql', async (req, res) => {\n    outputDebug('Handling /graphiql request', stdout)\n    if (!session || !(await isAuthorized())) {\n      return beginAuth(req, res)\n    }\n    res.send(\n      await renderLiquidTemplate(template, {\n        url: `https://${url}/${urlNamespaces.devTools}`,\n        defaultQueries: [{query: defaultQuery}],\n        apiVersion: LATEST_API_VERSION,\n        storeFqdn,\n        versions: Object.values(ApiVersion),\n        appName,\n        appUrl,\n        scopes,\n      }),\n    )\n  })\n\n  app.use(bodyParser.json())\n  // eslint-disable-next-line @typescript-eslint/no-misused-promises\n  app.post('/graphiql/graphql.json', async (req, res) => {\n    outputDebug('Handling /graphiql/graphql.json request', stdout)\n    if (!session) {\n      return res.json({errors: [{message: 'Not authenticated'}]})\n    }\n\n    const client = new shopify.clients.Graphql({\n      session,\n      apiVersion: (req.query.api_version ?? LATEST_API_VERSION) as ApiVersion,\n    })\n    try {\n      const {body} = await client.query({data: req.body})\n      res.json(body)\n      // eslint-disable-next-line no-catch-all/no-catch-all\n    } catch (error) {\n      res.status(500).json({errors: [error]})\n    }\n  })\n  return app.listen(port, () => stdout.write('GraphiQL server started'))\n}\n"]}